@using KOAHome.Helpers
@using System.Text.Json
@using Microsoft.Data.SqlClient
@using Npgsql
@{
    Layout = "~/Views/Shared/_ContentNavbarLayout.cshtml";
    var resultList = ViewData["resultList"] as List<dynamic>;

    // truyen cau hinh report de xu ly giao dien
    var report = ViewData["report"] as IDictionary<string, object>;
    string ReportCode = ViewData["ReportCode"] as string;

    // truyen danh sach gia tri loc len giao dien
    var listFilterValue = ViewData["ListFilterValue"] as IDictionary<string, object>;
    var listFilterConfig = ViewData["ListFilterConfig"] as List<dynamic>;

    // neu ton tai report thi xu ly tiep
    if (report != null)
    {
        // neu co default filter thi x·ª≠ l√Ω theo default filter
        if (listFilterConfig != null){
            // tra ve title cho page
            ViewData["Title"] = listFilterValue.ContainsKey("title") ? listFilterValue["title"] : report.ContainsKey("name") ? report["name"] : "Danh s√°ch";
        }
        else{
            // nguoc lai thi theo report
            // // tra ve title cho page
            ViewData["Title"] = report.ContainsKey("name") ? report["name"] : "Danh s√°ch";
        }
    }
    else{
        ViewData["Title"] = "Danh s√°ch";
    }

    // danh s√°ch select list ch·ª©a danh m·ª•c c·ªßa c√°c selectbox, radio, dropdownbox thuoc filter
    var dynamicServiceSelectOptions = ViewData["DynamicServiceSelectOptions"] as Dictionary<string, List<SelectListItem>>;
    // danh s√°ch select list ch·ª©a danh m·ª•c c·ªßa c√°c selectbox, radio, dropdownbox thuoc display editor
    var editorDynamicServiceSelectOptions = ViewData["EditorDynamicServiceSelectOptions"] as Dictionary<string, List<SelectListItem>>;

    // truyen danh sach gia tri cot du lieu len giao dien
    var displayList = ViewData["displayList"] as List<dynamic>;
    // t√≠nh c·∫•p cha con display (mac dinh chi lay 1)
    int displayParentLevelNum = ViewData.ContainsKey("displayParentLevelNum") ? Convert.ToInt32(ViewData["displayParentLevelNum"]) : 1;

    // tao bien dem de dem row num cho report
    var reportRowIndex = 1;



}

@section VendorStyles {
    <link rel="stylesheet" href="~/vendor/libs/apex-charts/apex-charts.css" />
}

@section VendorScripts {
    <script src="~/vendor/libs/apex-charts/apexcharts.js"></script>
}

@section PageScripts {
    @* thong bao day *@
    <script src="~/js/ui-toasts.js"></script>
    @* validate, kem cac file js ho tro *@
    <script src="~/js/helper.js"></script>
    <script src="~/js/flatpickr.js"></script>
    <script src="~/js/ui-popover.js"></script>

    <script>
        // Global scope
        var fv;
        let fieldValidationsArray = @Html.Raw((string.IsNullOrWhiteSpace(ViewData["editorcolumnvalidation"]?.ToString()) ? "[]" : ViewData["editorcolumnvalidation"]));

        // t·ª± ƒë·ªông add param t·ª´ link v√†o hidden input
        window.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const hiddenDiv = document.getElementById("hiddenInputs");

        urlParams.forEach((value, key) => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "q_"+key;
        input.value = value;
        hiddenDiv.appendChild(input);
        });
        });


        // editor form validation
        $(document).ready(function () {
            let form = document.querySelector("#editor-form");
            if (form) {

              fv = FormValidation.formValidation(form, {
                  fields: {},
                  plugins: {
                    trigger: new FormValidation.plugins.Trigger,
                    bootstrap5: new FormValidation.plugins.Bootstrap5({
                      rowSelector: ".form-control-validation", // ho·∫∑c class row ph√π h·ª£p
                      eleInvalidClass: 'is-invalid',
                      eleValidClass: 'is-valid'
                    }),
                    autoFocus: new FormValidation.plugins.AutoFocus,
                    submitButton: new FormValidation.plugins.SubmitButton,
                  },
                  init: instance => {
                    instance.on("plugins.message.placed", function (ev) {
                        if (ev.element.parentElement.classList.contains("input-group")) {
                            ev.element.parentElement.insertAdjacentElement("afterend", ev.messageElement);
                        }
                    });
                    instance.on('core.form.valid', function() {
                        // ‚úÖ KH√îNG submit, KH√îNG l√†m g√¨ ·ªü ƒë√¢y c·∫£
                        // ƒê·ªÉ form ti·∫øp t·ª•c ch·∫°y c√°c h√†m kh√°c (onsubmit...)
                        console.log("‚úÖ Form ƒë√£ ƒë∆∞·ª£c ki·ªÉm tra h·ª£p l·ªá, ti·∫øp t·ª•c x·ª≠ l√Ω ·ªü n∆°i kh√°c...");
                        const event = new Event("submit", { bubbles: true, cancelable: true });
                        form.dispatchEvent(event); // ‚úÖ G·ªçi l·∫°i s·ª± ki·ªán submit g·ªëc
                        form.submit();
                    });
                  }
              });

              // L·∫•y to√†n b·ªô input trong form c√≥ name
              // L·∫•y to√†n b·ªô input/select/textarea c√≥ name, trong #editor-form,
              // v√† KH√îNG n·∫±m trong <tr class="d-none">
              $('#editor-form')
                .find('input[name], select[name], textarea[name]')
                .filter(function () {
                    const $input = $(this);
                    const $tr = $input.closest('tr');

                    // ‚úÖ Ch·ªâ gi·ªØ input c√≥ name v√† <tr> kh√¥ng c√≥ class d-none
                    return $input.attr('name') && !$tr.hasClass('d-none');
                })
                .each(function () {
                    const input = $(this);
                    const nameAttr = input.attr('name');

                    fieldValidationsArray.forEach(fieldObj => {
                        const key = Object.keys(fieldObj)[0];
                        if (nameAttr.includes(key)) {
                            fv.addField(nameAttr, fieldObj[key]);
                        }
                    });
                });
                console.log("üß™ Editor Form validation instance:", fv);

                // g·ªçi datatable ƒë·ªÉ ki·ªÉm tra v√† x·ª≠ l√Ω
                const $table = $('#editor-form table');
                if ($.fn.dataTable.isDataTable($table)) {
                    dt = $table.DataTable();
                } else {
                    dt = $table.DataTable({
                        // c·∫•u h√¨nh n·∫øu c·∫ßn
                    });
                }

                  // üëá H√†m ƒë·ªÉ add l·∫°i fields ch·ªâ cho d√≤ng hi·ªán t·∫°i sau khi ph√¢n trang
                function rebindFormValidationFields() {
                    // üßπ X√≥a c√°c field c≈©
                    Object.keys(fv.getFields()).forEach(field => fv.removeField(field));

                    // üîÑ L·∫•y input/select trong c√°c d√≤ng hi·ªán t·∫°i
                    dt
                        .rows({ page: 'current' })
                        .nodes()
                        .to$()
                        .find('input[name], select[name], textarea[name]')
                        .filter(function () {
                            const $input = $(this);
                            const $tr = $input.closest('tr');
                            return !$tr.hasClass('d-none');
                        })
                        .each(function () {
                            const input = $(this);
                            const nameAttr = input.attr('name');

                            fieldValidationsArray.forEach(fieldObj => {
                                const key = Object.keys(fieldObj)[0];
                                if (nameAttr.includes(key)) {
                                    fv.addField(nameAttr, fieldObj[key]);
                                }
                            });
                        });
                }

                // ü™Ñ G·ªçi l·∫°i khi DataTable ph√¢n trang, l·ªçc, sort...
                // Rebind khi ph√¢n trang, l·ªçc, sort
                $table.on('draw.dt', function () {
                    rebindFormValidationFields();
                });
            }
        });

        // them dong editor moi
      function addNewRow(tableid = "ReportEditor") {
          const table = document.getElementById(tableid).getElementsByTagName('tbody')[0];
          const templateRow = table.querySelector('tr[data-template="true"]');
          const newIndex = table.rows.length + 1;

          if (!templateRow) {
          console.error("Kh√¥ng t√¨m th·∫•y d√≤ng m·∫´u!");
          return;
          }

          // 1. Destroy select2 tr√™n templateRow tr∆∞·ªõc
          const $select = $(templateRow).find("select");

          if ($select.hasClass("select2-hidden-accessible")) {
          $select.select2('destroy');
          }

          // Optionally clear ID (n·∫øu c·∫ßn clone nhi·ªÅu d√≤ng tr√°nh id tr√πng)
          $select.removeAttr("id");

          // Clone d√≤ng m·∫´u
          const newRow = templateRow.cloneNode(true);
          newRow.removeAttribute("data-template");
          newRow.style.display = "";
          // G√°n thu·ªôc t√≠nh change tracking n·∫øu c·∫ßn
          newRow.setAttribute("data-changed", "true");
          newRow.setAttribute("data-template", "false");
          // x√≥a class ·∫©n tr
          newRow.classList.remove("d-none");

          // Replace t·∫•t c·∫£ {{index}} trong thu·ªôc t√≠nh name
          newRow.innerHTML = newRow.innerHTML.replace(/grid\[\d+\]/g, `grid[${newIndex}]`);

          // Sau khi clone xong, l√†m s·∫°ch HTML c√°c class ho·∫∑c message container
          newRow.querySelectorAll('.fv-plugins-icon-container').forEach(td => {
              const msg = td.querySelector('.fv-plugins-message-container');
              if (msg) msg.remove();

              td.classList.remove('fv-plugins-bootstrap5-row-invalid');

              const input = td.querySelector('input, select, textarea');
              if (input) input.classList.remove('is-invalid');
          });

          // Th√™m v√†o ƒë·∫ßu b·∫£ng ho·∫∑c cu·ªëi b·∫£ng
          const firstRow = table.querySelector('tr[data-template="false"]');
          if (firstRow) {
          table.insertBefore(newRow, firstRow);
          } else {
          table.appendChild(newRow);
          }

          // √Åp d·ª•ng Select2 n·∫øu c√≥
          $(newRow).find("select").select2({
          placeholder: "Ch·ªçn",
          allowClear: true,
          width: "100%"
          });


          // // √°p d·ª•ng color picker (n·∫øu c√≥)
          // Init_getColorPicker();

        // ‚úÖ Th√™m field m·ªõi v√†o FormValidation n·∫øu c√≥ ƒë·ªãnh nghƒ©a s·∫µn
        $(newRow).find('input[name], select[name], textarea[name]').each(function () {
            const input = $(this);
            const nameAttr = input.attr('name');

            // Ki·ªÉm tra n·∫øu name tr√πng v·ªõi key rule c√≥ s·∫µn th√¨ th√™m v√†o
            fieldValidationsArray.forEach(fieldObj => {
                const key = Object.keys(fieldObj)[0];

                if (nameAttr.includes(key)) {
                    console.log("‚ûï Add dynamic field:", nameAttr, "with rule:", fieldObj[key]);

                    if (Array.isArray(fieldObj[key]) && fieldObj[key].length === 0) {
                        console.warn("‚ö†Ô∏è Kh√¥ng c√≥ rule n√†o cho:", nameAttr);
                        return;
                    }

                    fv.addField(nameAttr, fieldObj[key]);
                }
            });
        });
        }


        // xu ly du lieu ngay trong report editor
        var gridData = @Html.Raw(Json.Serialize(ViewData["resultList"]));
        if (gridData != null)
        {
        $(document).ready(function () {
        $.each(gridData, function (index, rowData) {
        // T√¨m t·∫•t c·∫£ input/select trong d√≤ng c√≥ name ƒë·ªông
        $(`#ReportEditor tbody tr:eq(${index})`).find("input, select, textarea").each(function () {
        let fieldName = $(this).attr("name"); // L·∫•y name c·ªßa input
        if (!fieldName) return; // N·∫øu kh√¥ng c√≥ name, b·ªè qua

        // Regex ƒë·ªÉ l·∫•y t√™n key t·ª´ `grid[index].FieldName`
        let match = fieldName.match(/\[(\d+)\]\.(\w+)/);
        if (!match) return; // N·∫øu kh√¥ng kh·ªõp format, b·ªè qua

        let fieldKey = match[2]; // L·∫•y ph·∫ßn FieldName (v√≠ d·ª•: "ServiceID", "Quantity",...)

        if (rowData.hasOwnProperty(fieldKey)) {
        let value = rowData[fieldKey];

        // Ki·ªÉm tra ki·ªÉu input v√† format l·∫°i n·∫øu c·∫ßn
        if ($(this).attr("type") === "datetime-local") {
        value = formatDateTimeLocal(value);
        // G√°n gi√° tr·ªã v√†o input
        $(this).val(value);
        } else if ($(this).attr("type") === "date") {
        value = formatDate(value);
        // G√°n gi√° tr·ªã v√†o input
        $(this).val(value);
        } else if ($(this).attr("type") === "time") {
        value = formatTime(value);
        // G√°n gi√° tr·ªã v√†o input
        $(this).val(value);
        }
        // N·∫øu l√† select2, c·∫ßn trigger ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
        if ($(this).is("select")) {
        $(this).trigger("change");
        }
        }
        });
        });
        });
        }

    </script>
}
@section success
{
    @if (ViewData["success"] != null)
    {

        <!-- Toast with Placements -->
        <div class="bs-toast toast  top-0 end-0 show toast-placement-ex1 m-2" style="position:absolute;" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
            <div class="toast-header">
                <i class="ri-home-4-fill me-2 text-success"></i>
                <div class="me-auto fw-medium">Th√¥ng b√°o</div><small class="text-muted">1 gi√¢y tr∆∞·ªõc</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body text-success">@ViewData["success"].</div>
        </div>
        <!-- Toast with Placements -->
    }
}

@section ErrorMessage
{
    @if (ViewData["ErrorMessage"] != null)
    {
        <!-- Toast with Placements -->
        <div class="bs-toast toast  top-0 end-0 show toast-placement-ex1 m-2" style="position:absolute;" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
            <div class="toast-header">
                <i class="ri-home-4-fill me-2 text-danger"></i>
                <div class="me-auto fw-medium">Th√¥ng b√°o</div><small class="text-muted">1 gi√¢y tr∆∞·ªõc</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body text-danger">@ViewData["ErrorMessage"].</div>
        </div>
        <!-- Toast with Placements -->
    }
}


@* ************** Content ************** *@
<!-- Content wrapper -->
<div class="content-wrapper">
    <!-- Content -->
    @if (report != null)
    {
    <div class="container-xxl flex-grow-1 container-p-y">
        <div class="row gy-6">
            @* Data Table new *@
            <!-- Data Tables -->
                <div class="col-xl-12">
                    <div class="card h-100 overflow-hidden">
                    <h2 class="card-header text-center" id="header-title">@(listFilterValue.ContainsKey("title") ? listFilterValue["title"] : report.ContainsKey("name") ? report["name"] : "Danh s√°ch")</h2>
                      <div class="card-body" id="vertical-example">
                        <!-- Accordion -->
                        <!-- phan mo rong de an hien bo loc-->
                        <div class="row">
                            <div class="col-md mb-6 mb-md-2">
                                <div class="accordion mt-4" id="accordionExample">
                                    <div class="accordion-item active">
                                        <h2 class="accordion-header" id="headingOne">
                                            <button type="button" class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#accordionOne" aria-expanded="true" aria-controls="accordionOne">
                                                T√¨m ki·∫øm n√¢ng cao
                                            </button>
                                        </h2>
                                        <div id="accordionOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                                            <div class="accordion-body">
                                                @* filter *@
                                                <form id = "reportfilter" method="get"class="needs-validation" novalidate="" action="/report/editor-utility/@ReportCode" enctype="multipart/form-data">
                                                    @* report code mac dinh truyen vao bo loc *@
                                                    <div class="row gx-3 gy-2 align-items-center">
                                                        @* xu ly filter dong *@
                                                        @if(listFilterConfig != null)
                                                        {
                                                            foreach (var filter in listFilterConfig.OrderBy(p => p.orderid).ToList())
                                                            {
                                                                @* name: Key cua filter truyen vao, label: Ten filter, type: Lo·∫°i filter, value: gi√° tr·ªã filter
                                                        , colspan: ƒë·ªô r·ªông filter *@
                                                                string name = filter.code;
                                                                string label = filter.name;
                                                                string type = filter.dynamicfieldname;
                                                                var value = listFilterValue.ContainsKey(name) ? listFilterValue[name] : "";
                                                                int colspan = Convert.ToInt32(filter.colspan);

                                                                @* neu colspan = 0 thi mac dinh = 4, neu khong thi lay colspan *@
                                                                <div class="col-md-@(Convert.ToInt32(filter.colspan) == 0 ? "4" : @filter.colspan) form-floating form-floating-outline mb-6">
                                                                    @if (type == "TEXT BOX")
                                                                    {
                                                                        <input class="form-control form-control-sm" type="text" id="@name" name="@name" value="@value" @(filter.required == true ? "required" : "") />
                                                                    }
                                                                    else if (type == "DATE BOX")
                                                                    {
                                                                        <input class="form-control form-control-sm" type="date" id="@name" name="@name" value="@value" @(filter.required == true ? "required" : "") />
                                                                    }
                                                                    else if (type == "DATERANGEPICKER")
                                                                    {
                                                                        <input class="form-control form-control-sm bs-rangepicker-filter" type="text" id="@name" name="@name" value="@value" @(filter.required == true ? "required" : "") />
                                                                    }
                                                                    else if (type == "SELECT BOX")
                                                                    {
                                                                        @* check selected cho item dung voi gia tri *@
                                                                        var selectList = dynamicServiceSelectOptions[name] as List<SelectListItem> ?? new List<SelectListItem>();
                                                                        @foreach (var item in selectList)
                                                                        {
                                                                            if (value != null)
                                                                            {
                                                                                item.Selected = (item.Value.ToString() == value.ToString()); // currentValue l√† gi√° tr·ªã ƒëang ƒë∆∞·ª£c ch·ªçn
                                                                            }
                                                                        }
                                                                        var selectAttributes = new Dictionary<string, object>
                                                                              {
                                                                                { "class", "form-select color-dropdown form-select-sm" },
                                                                                { "id", name },
                                                                                { "name", name }
                                                                              };

                                                                        // neu bat buoc thi them truong bat buoc
                                                                        if (filter.required == true)
                                                                        {
                                                                            selectAttributes["required"] = "required";
                                                                        }

                                                                        @Html.DropDownList(name, selectList, "-- Ch·ªçn --", selectAttributes)
                                                                    }
                                                                    else if (type == "TREEVIEW MULTIPLE")
                                                                    {
                                                                        @* check selected cho item dung voi gia tri *@
                                                                        var selectList = dynamicServiceSelectOptions[name] as List<SelectListItem> ?? new List<SelectListItem>();
                                                                        @foreach (var item in selectList)
                                                                        {
                                                                            if (value != null)
                                                                            {
                                                                                // split chuoi value thanh List string ƒë·ªÉ x·ª≠ l√Ω
                                                                                var splitvalue = value.ToString().Split(",", StringSplitOptions.RemoveEmptyEntries);
                                                                                // ki·ªÉm tra cac gi√° tr·ªã c√≥ kh·ªõp kh√¥ng
                                                                                item.Selected = (splitvalue.Any(s => s.Trim().Equals(item.Value.ToString(), StringComparison.OrdinalIgnoreCase))); // currentValue l√† gi√° tr·ªã ƒëang ƒë∆∞·ª£c ch·ªçn
                                                                            }
                                                                        }
                                                                        var selectAttributes = new Dictionary<string, object>
                                                                              {
                                                                                { "class", "form-select color-dropdown form-select-sm" },
                                                                                { "id", name },
                                                                                { "name", name },
                                                                                { "multiple", "multiple" }
                                                                              };

                                                                        // neu bat buoc thi them truong bat buoc
                                                                        if (filter.required == true)
                                                                        {
                                                                            selectAttributes["required"] = "required";
                                                                        }

                                                                        @Html.DropDownList(name, selectList, "-- Ch·ªçn --", selectAttributes)
                                                                    }
                                                                    <label for="@name">@label</label>
                                                                    <div class="valid-feedback"> Ch√≠nh x√°c! </div>
                                                                    <div class="invalid-feedback"> Kh√¥ng ƒë∆∞·ª£c b·ªè tr·ªëng. </div>
                                                                </div>
                                                            }
                                                        }

                                                    </div>
                                                    @* end filter *@
                                                    @* nut xem *@
                                                    <div class="row gx-3 gy-2 align-items-center">
                                                        <div class="col-md-12 d-flex justify-content-center">
                                                            <label class="form-label" for="showToastPlacement">&nbsp;</label>
                                                            <button type="submit" id="showToastPlacement" class="btn btn-primary d-block">Xem</button>
                                                        </div>
                                                    </div>
                                                    @* end nut xem *@
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--/ Accordion -->
                    @* end filter *@
                        @* table *@
                              @* form xu ly luu editor *@
                              <form id="editor-form" class="needs-validation" novalidate="" method="post" asp-controller="NETReport" asp-action="Editor_Utility" asp-route-reportCode="@ReportCode" enctype="multipart/form-data">
                                @* boc cac thanh phan cua table lai *@
                                <div id="@("table-editor-" + (ReportCode ?? "emptycode") + "-wrap")">
                                  @* action top *@
                                  <div class="gx-3 gy-2 align-items-center report-top-action">
                                  </div>
                                  @* end action top *@
                                  <div class="d-flex justify-content-between align-items-center">
                                      @* hien thi so dong duoc hien thi *@
                                      <div class="report-info d-flex gap-2"></div>
                                      @* button xu ly add row v√† submit *@
                                      <div class="d-flex gap-2">
                                          <button type="button" class="btn text-muted p-0" onclick="addNewRow('@("table-editor-" + ReportCode ?? "emptycode")')"><i class="ri-add-line ri-24px"></i></button>
                                          <button type="submit" class="btn text-muted p-0"><i class="ri-save-line ri-24px"></i></button>
                                      </div>
                                  </div>
                                  @* hidden input ƒë·ªÉ x·ª≠ l√Ω ·∫©n truy·ªÅn d·ªØ li·ªáu t·ª´ param link v√†o b·∫±ng js *@
                                  <div id="hiddenInputs"></div>
                                  <div class="table-responsive" style="max-height: 800px">
                                      <table id="@("table-editor-" + ReportCode ?? "emptycode")" data-table-displayname = "@(report.ContainsKey("name") ? (report["name"].ToString() ?? "Danh s√°ch") : "Danh s√°ch")" border="1" cellpadding="5" cellspacing="0" style="width: 100%; text-align: center; table-layout: auto;" class="table table-sm table-bordered display table-with-exportexcel">
                                          <thead class="freepanze-head">
                                              <tr>
                                                  @* C·ªôt n√†y s·∫Ω t·ª± ƒë·ªông ch·ª©a checkbox "Ch·ªçn t·∫•t c·∫£" *@
                                                  <th class="text-center" rowspan="@displayParentLevelNum" data-code="IdCheck" data-index="-1"  data-isexport="False" style="min-width:50px"></th>
                                                  @* C·ªôt chi ti·∫øt m·∫∑c ƒë·ªãnh*@
                                                  <th class="text-center" rowspan="@displayParentLevelNum" data-code="IdDetail" data-index="0"  data-isexport="False" style="min-width:10px"></th>
                                                  @* neu display khong null thi tiep tuc *@
                                                  @if (displayList != null)
                                                  {
                                                      @* voi moi cot dang co *@
                                                      @* neu cot isdisplay = false thi kh√¥ng hien thi (ch·ªâ l·∫•y gi√° tr·ªã)  *@
                                                      @foreach (var display in displayList.Where(p => p.isdisplay == false).OrderBy(p => p.colnum ?? 0).ToList())
                                                      {
                                                          <th class="text-center d-none" rowspan="@displayParentLevelNum" data-code="@display.code" data-index="@(display.colnum ?? "0")" data-isexport="@(display.isexport ?? "True")">@Html.Raw(display.name)</th>
                                                      }
                                                      @* hien thi cot stt dau tien neu co *@
                                                      @foreach (var display in displayList.Where(p => p.isdisplay == true && p.code == "stt" && p.isparent == false && string.IsNullOrEmpty(p.parentcode)).OrderBy(p => p.colnum ?? 0).ToList())
                                                      {
                                                          @* co dinh cot neu co cau hinh (chi ap dung cho cot 1 rowspan) *@
                                                          <th class="text-center @(display.isfreepane == true ? "freepanze-col" : "")" rowspan="@displayParentLevelNum" data-code="@display.code" data-index="@(display.colnum ?? "0")" data-isexport="@(display.isexport ?? "True")" style="min-width:@((display.width ?? "200") + "px");@(display.cssheader ?? "")">@Html.Raw(display.name)</th>
                                                      }
                                                      @* neu cot khong co parent code cung khong phai is parent thi xu ly rieng *@
                                                      @foreach (var display in displayList.Where(p => p.isdisplay == true && p.code != "stt" && p.isparent == false && string.IsNullOrEmpty(p.parentcode)).OrderBy(p => p.colnum ?? 0).ToList())
                                                      {
                                                          @* co dinh cot neu co cau hinh (chi ap dung cho cot 1 rowspan) *@
                                                          <th class="text-center @(display.isfreepane == true ? "freepanze-col" : "")" rowspan="@displayParentLevelNum" data-code="@display.code" data-index="@(display.colnum ?? "0")" data-isexport="@(display.isexport ?? "True")" style="min-width:@((display.width ?? "200") + "px");@(display.cssheader ?? "")">@Html.Raw(display.name)</th>
                                                      }
                                                      @* neu ton tai cot co isparent thi xu ly tiep cot 2 cap *@
                                                      @if (displayList.Any(p => p.isparent == true))
                                                      {
                                                          @* hien thi cot cha *@
                                                          @foreach (var display in displayList.Where(p => p.isdisplay == true && p.isparent == true).OrderBy(p => p.colnum ?? 0).ToList())
                                                          {
                                                              @* dem so cot con de tinh colspan *@
                                                              var countChild = displayList.Count(p => p.parentcode == display.code);
                                                              @* neu co cot con thi xu ly tiep *@
                                                              if (countChild > 0)
                                                              {
                                                                  <th class="text-center" colspan="@countChild" data-code="@display.code" data-isexport="@(display.isexport ?? "True")" style="@(display.cssheader ?? "")">@Html.Raw(display.name)</th>
                                                              }

                                                          }
                                                      }
                                                      @* them nut xoa cuoi d√≤ng *@
                                                      <th class="text-center" style="width:100px;">H√†nh ƒë·ªông</th>

                                                  }
                                              </tr>
                                              @* neu co cap cha con thi tiep tuc *@
                                              @if (displayParentLevelNum > 1)
                                              {
                                                  <tr>
                                                      @* neu display khong null thi tiep tuc *@
                                                      @if (displayList != null)
                                                      {
                                                          @* voi moi cot dang co *@
                                                          @* neu ton tai cot co isparent thi xu ly tiep cot 2 cap *@
                                                          @if (displayList.Any(p => p.isparent == true))
                                                          {
                                                              @* hien thi cot cha *@
                                                              @foreach (var display in displayList.Where(p => p.isdisplay == true && p.isparent == true).OrderBy(p => p.colnum ?? 0).ToList())
                                                              {
                                                                  @* dem so cot con de tinh colspan *@
                                                                  var countChild = displayList.Count(p => p.parentcode == display.code);
                                                                  @* neu co cot con thi xu ly tiep *@
                                                                  @if (countChild > 0)
                                                                  {
                                                                      @foreach (var displaychild in displayList.Where(p => p.isdisplay == true && p.parentcode == display.code).OrderBy(p => p.colnum ?? 0).ToList())
                                                                      {
                                                                          <th class="text-center" data-code="@display.code" data-index="@(displaychild.colnum ?? "0")" data-isexport="@(displaychild.isexport ?? "True")" style="min-width:@(displaychild.width ?? "200")px;@(displaychild.cssheader ?? "")">@Html.Raw(displaychild.name)</th>
                                                                      }
                                                                  }

                                                              }
                                                          }
                                                      }
                                                  </tr>
                                              }
                                          </thead>
                                          <tbody class="overflow-auto">
                                              @if (resultList != null && displayList != null)
                                              {
                                                  // Th√™m d√≤ng template r·ªóng
                                                  var templateRow = new Dictionary<string, object>();

                                                  foreach (var display in displayList)
                                                  {
                                                      templateRow[display.code] = null; // ho·∫∑c "" n·∫øu c·∫ßn
                                                  }

                                                  // ƒê√°nh d·∫•u l√† d√≤ng m·∫´u
                                                  templateRow["IsTemplateRow"] = true;

                                                  // Th√™m l√™n ƒë·∫ßu danh s√°ch
                                                  resultList.Insert(0, templateRow);

                                                  @* voi moi dong resultlist *@
                                                  @foreach (var result in resultList
                                                  .OrderBy(p =>
                                                  {
                                                      try
                                                      {
                                                          object sttObj;
                                                          if (((IDictionary<string, object>)p).TryGetValue("stt", out sttObj) && sttObj != null)
                                                          {
                                                              return Convert.ToInt32(sttObj);
                                                          }
                                                      }
                                                      catch { }
                                                      return 0;
                                                  })
                                                  .ToList()
                                                  )
                                                  {
                                                      var dictionary = (IDictionary<string, object>)result;
                                                      var Id = dictionary.ContainsKey("Id") ? Convert.ToInt32(dictionary["Id"]) : 0;
                                                      @* lay gia tri to mau background row (BGColorRowClass) *@
                                                      var bgColorRowClass = dictionary.ContainsKey("BGColorRowClass") ? Convert.ToString(dictionary["BGColorRowClass"]) : "";
                                                      @* ki·ªÉm tra n·∫øu l√† TemplateRow th√¨ ·∫©n *@
                                                      var isTemplateRow = dictionary.ContainsKey("IsTemplateRow") && (bool)dictionary["IsTemplateRow"];

                                                      <tr class="@bgColorRowClass @(Convert.ToBoolean(isTemplateRow) ? "d-none" : "")" data-changed="false" data-template="@(Convert.ToBoolean(isTemplateRow) ? "true" : "false")">
                                                          @* c·ªôt select box m·∫∑c ƒëinh *@
                                                          <td class="text-center" data-isexport="False" data-value="@Id">
                                                          </td>
                                                          @* c·ªôt chi ti·∫øt m·∫∑c ƒëinh *@
                                                          <td class="text-center" data-isexport="False">
                                                          </td>
                                                          @* voi moi cot dang co *@
                                                          @* neu cot isdisplay = false thi khong hien thi  *@
                                                          @foreach (var display in displayList.Where(p => p.isdisplay == false).OrderBy(p => p.colnum ?? 0).ToList())
                                                          {
                                                              <td class="@FormatHelper.ParseTextAlignToClass(display.textalign) d-none form-control-validation fv-plugins-icon-container" data-isexport="@(display.isexport ?? "True")">
                                                                  @{
                                                                      object value;
                                                                      if (dictionary.TryGetValue(display.code, out value))
                                                                      {
                                                                          <input class="form-control text-center" type="text" name="@("grid["+@reportRowIndex+"]."+display.code)" value="@value" readonly />
                                                                      }
                                                                      else
                                                                      {
                                                                          <span class="text-muted">N/A</span> @* Gi√° tr·ªã m·∫∑c ƒë·ªãnh *@
                                                                      }
                                                                  }
                                                              </td>
                                                          }
                                                          @* hien thi cot stt dau tien neu co *@
                                                          @foreach (var display in displayList.Where(p => p.isdisplay == true && p.code == "stt" && p.isparent == false && string.IsNullOrEmpty(p.parentcode)).OrderBy(p => p.colnum ?? 0).ToList())
                                                          {
                                                              @* neu isFreePane bang true thi them class freepanze-col *@
                                                              <td class="text-center @(display.isfreepane == true ? "freepanze-col" : "") form-control-validation fv-plugins-icon-container" data-isexport="@(display.isexport ?? "True")">
                                                                  @{
                                                                      object value;
                                                                      if (dictionary.TryGetValue(display.code, out value))
                                                                      {
                                                                          <input class="form-control text-center" type="text" name="@("grid["+@reportRowIndex+"]."+display.code)" value="@value" readonly />
                                                                      }
                                                                      else
                                                                      {
                                                                          <span class="text-muted">N/A</span> @* Gi√° tr·ªã m·∫∑c ƒë·ªãnh *@
                                                                      }
                                                                  }
                                                              </td>
                                                          }
                                                          @* neu cot khong co parent code cung khong phai is parent thi xu ly rieng *@
                                                          @foreach (var display in displayList.Where(p => p.isdisplay == true && p.code != "stt" && p.isparent == false && string.IsNullOrEmpty(p.parentcode)).OrderBy(p => p.colnum ?? 0).ToList())
                                                          {
                                                              @* m·∫∑c ƒë·ªãnh type l√† string *@
                                                              var displayType = display.type as string ?? "string";
                                                              var displayFormat = display.format as string ?? "";
                                                              string[] numberTypeArray = ["int", "float", "long"];
                                                              string[] dateTypeArray = ["date", "datetime"];
                                                              @* neu isFreePane bang true thi them class freepanze-col *@
                                                              <td class="@FormatHelper.ParseTextAlignToClass(display.textalign) @(display.isfreepane == true ? "freepanze-col" : "") form-control-validation fv-plugins-icon-container" data-isexport="@(display.isexport ?? "True")" data-displaytype="@displayType" data-displayformat="@displayFormat">
                                                                  @{
                                                                      object value;
                                                                      if (dictionary.TryGetValue(display.code, out value))
                                                                      {
                                                                          string valueType = "";
                                                                          // kiem tra kieu du lieu cua value
                                                                          if (@value != null)
                                                                          {
                                                                              valueType = value.GetType().ToString();
                                                                          }
                                                                          // uu tien kiem tra kieu du lieu cua value roi den display
                                                                          // neu kieu du lieu cua value la boolean thi su dung check box
                                                                          @if (valueType == "System.Boolean" || displayType == "boolean")
                                                                          {
                                                                              <input class="form-check-input track-change" type="checkbox" name="@("grid["+@reportRowIndex+"]."+display.code)" value="true" @(Convert.ToBoolean(value ?? false) ? "checked" : "") @(display.validationrule != "[]" ? "required" : "") @(Convert.ToBoolean(display.isreadonly ?? false) ? "disabled" : "") />

                                                                          }
                                                                          else if (displayType == "icons")
                                                                          {
                                                                              var iconsJson = value?.ToString()?.Trim() ?? "";

                                                                              // N·∫øu r·ªóng th√¨ b·ªè qua
                                                                              if (!string.IsNullOrEmpty(iconsJson))
                                                                              {
                                                                                  // ƒê·∫£m b·∫£o chu·ªói JSON lu√¥n l√† m·∫£ng
                                                                                  if (iconsJson.TrimStart().StartsWith("{"))
                                                                                  {
                                                                                      iconsJson = "[" + iconsJson + "]";
                                                                                  }

                                                                                  try
                                                                                  {
                                                                                      var icons = JsonSerializer.Deserialize<List<JsonElement>>(iconsJson);

                                                                                      <ul class="list-unstyled m-0 avatar-group d-flex align-items-center">
                                                                                          @foreach (var icon in icons)
                                                                                          {
                                                                                              var title = icon.GetProperty("title").GetString();
                                                                                              var image = icon.GetProperty("image").GetString();
                                                                                              <li data-bs-toggle="tooltip"
                                                                                                  data-popup="tooltip-custom"
                                                                                                  data-bs-placement="top"
                                                                                                  class="avatar avatar-xs pull-up"
                                                                                                  aria-label="@title"
                                                                                                  data-bs-original-title="@title">
                                                                                                  <img src="@image" alt="Avatar" class="rounded-circle" />
                                                                                              </li>
                                                                                          }
                                                                                      </ul>
                                                                                  }
                                                                                  catch (SqlException ex)
                                                                                  {
                                                                                      <span class="text-danger">N/A</span>
                                                                                  }
                                                                              }
                                                                          }
                                                                          // neu dang file thi hien thi icon t·∫£i nhi·ªÅu file
                                                                          else if (displayType == "file")
                                                                          {
                                                                              var filesJson = value?.ToString()?.Trim() ?? "";

                                                                              // N·∫øu r·ªóng th√¨ b·ªè qua
                                                                              if (!string.IsNullOrEmpty(filesJson))
                                                                              {
                                                                                  // N·∫øu l√† object ƒë∆°n, bao l·∫°i th√†nh m·∫£ng
                                                                                  if (filesJson.StartsWith("{"))
                                                                                  {
                                                                                      filesJson = "[" + filesJson + "]";
                                                                                  }

                                                                                  try
                                                                                  {
                                                                                      var fileList = JsonSerializer.Deserialize<List<JsonElement>>(filesJson);

                                                                                      if (fileList?.Count > 0)
                                                                                      {
                                                                                          <div class="d-flex flex-wrap gap-1">
                                                                                              @foreach (var file in fileList)
                                                                                              {
                                                                                                  var fileName = file.GetProperty("fileName").GetString();
                                                                                                  var url = file.GetProperty("url").GetString();
                                                                                                  var displayName = fileName?.Length > 50 ? fileName.Substring(0, 50) + "..." : fileName;

                                                                                                  <a href="@url" download class="btn btn-sm btn-outline-primary file-download-link" title="@fileName">
                                                                                                      <i class="ri-download-2-fill"></i> @displayName
                                                                                                  </a>
                                                                                              }
                                                                                          </div>
                                                                                      }
                                                                                  }
                                                                                  catch
                                                                                  {
                                                                                      <span class="text-danger">L·ªói ƒë·ªãnh d·∫°ng file JSON</span>
                                                                                  }
                                                                              }
                                                                          }
                                                                          // neu la kieu link thi parse thanh html
                                                                          else if (displayType == "link")
                                                                          {
                                                                              @Html.Raw(value)
                                                                              ;
                                                                          }
                                                                          // ki·ªÉu string
                                                                          else if (displayType == "string")
                                                                          {
                                                                              <input class="form-control track-change @FormatHelper.ParseTextAlignToClass(display.textalign)" type="text" name="@("grid["+@reportRowIndex+"]."+display.code)" value="@value" @(Convert.ToBoolean(display.isreadonly ?? false) ? "readonly" : "") @(display.validationrule != "[]" ? "required" : "") />
                                                                          }
                                                                          // ki·ªÉu color
                                                                          else if (displayType == "color")
                                                                          {
                                                                            <div class="pickr">
                                                                              <button type="button" id="@("color-"+("grid-"+@reportRowIndex+"-"+display.code))" class="pcr-button form-color-picker" role="button" @(Convert.ToBoolean(display.isreadonly ?? false) ? "disabled" : "")></button>
                                                                              <input type="hidden" class="track-change" id="@("grid-"+@reportRowIndex+"-"+display.code)" name="@("grid["+@reportRowIndex+"]."+display.code)" value="@value"  @(display.validationrule != "[]" ? "required" : "") />
                                                                            </div>
                                                                          }
                                                                          // ki·ªÉu textarea
                                                                          else if (displayType == "textarea")
                                                                          {
                                                                              <textarea row="2" class="form-control track-change @FormatHelper.ParseTextAlignToClass(display.textalign)" name="@("grid["+@reportRowIndex+"]."+display.code)" aria-label="@display.name" @(Convert.ToBoolean(display.isreadonly ?? false) ? "readonly" : "") @(display.validationrule != "[]" ? "required" : "")>@value</textarea>
                                                                          }
                                                                          // neu la kieu number thi hien thi input number
                                                                          else if (numberTypeArray.Contains(displayType))
                                                                          {
                                                                              <input class="form-control track-change @FormatHelper.ParseTextAlignToClass(display.textalign)" type="number" placeholder="" name="@("grid["+@reportRowIndex+"]."+display.code)" aria-label="@display.name" value="@value" @(Convert.ToBoolean(display.isreadonly ?? false) ? "readonly" : "") @(display.validationrule != "[]" ? "required" : "")>
                                                                          }
                                                                          // ki·ªÉu ng√†y
                                                                          else if (dateTypeArray.Contains(displayType))
                                                                          {
                                                                              string[] dateFormatArray = ["dd/MM/yyyy", ""];
                                                                              string dateBoxType = "";
                                                                              if (displayType == "date" && dateFormatArray.Contains(displayFormat))
                                                                              {
                                                                                  dateBoxType = "date";
                                                                              }
                                                                              else
                                                                              {
                                                                                  dateBoxType = "datetime-local";
                                                                              }

                                                                              <input type="@dateBoxType" class="form-control track-change @FormatHelper.ParseTextAlignToClass(display.textalign)" name="@("grid["+@reportRowIndex+"]."+display.code)" aria-label="@display.name" value="@value" @(Convert.ToBoolean(display.isreadonly ?? false) ? "readonly" : "") @(display.validationrule != "[]" ? "required" : "")>
                                                                          }
                                                                          else if (displayType == "combobox")
                                                                          {
                                                                              // check selected cho item dung voi gia tri
                                                                              var selectList = editorDynamicServiceSelectOptions[display.code] as List<SelectListItem> ?? new List<SelectListItem>();
                                                                              @foreach (var item in selectList)
                                                                              {
                                                                                  if (value != null)
                                                                                  {
                                                                                      item.Selected = (item.Value.ToString() == value.ToString()); // currentValue l√† gi√° tr·ªã ƒëang ƒë∆∞·ª£c ch·ªçn
                                                                                  }
                                                                              }
                                                                              var selectAttributes = new Dictionary<string, object>
                                                  {
                                                  { "class", "form-select track-change" },
                                                  { "name", ("grid["+@reportRowIndex+"]."+display.code) }
                                                  };

                                                                              // neu bat buoc thi them truong bat buoc
                                                                              if (display.validationrule != "[]")
                                                                              {
                                                                                  selectAttributes["required"] = "required";
                                                                              }

                                                                              @Html.DropDownList(("grid[" + @reportRowIndex + "]." + display.code), selectList, "-- Ch·ªçn --", selectAttributes)
                                                                          }
                                                                          else if (displayType == "radio")
                                                                          {
                                                                              // check selected cho item dung voi gia tri
                                                                              var selectList = editorDynamicServiceSelectOptions[display.code] as List<SelectListItem> ?? new List<SelectListItem>();

                                                                              @if (selectList != null)
                                                                              {
                                                                                  foreach (var item in selectList)
                                                                                  {
                                                                                      <div class="form-check form-check-inline track-change">
                                                                                          <input type="radio" class="form-check-input"
                                                                                                  name="@("grid["+@reportRowIndex+"]."+display.code)"
                                                                                                  id="@(("grid["+@reportRowIndex+"]."+display.code) + "_" + item.Value)"
                                                                                                  value="@item.Value"
                                                                                          @((value ?? "").ToString() == item.Value.ToString() ? "checked" : "") />
                                                                                          <label class="form-check-label" for="@(("grid["+@reportRowIndex+"]."+display.code) + "_" + item.Value)">@item.Text</label>
                                                                                      </div>
                                                                                  }
                                                                              }
                                                                          }
                                                                          else
                                                                          {
                                                                              <input class="form-control track-change @FormatHelper.ParseTextAlignToClass(display.textalign)" type="text" name="@("grid["+@reportRowIndex+"]."+display.code)" value="@value" @(Convert.ToBoolean(display.isreadonly ?? false) ? "readonly" : "") @(display.validationrule != "[]" ? "required" : "") />

                                                                          }                                              }
                                                                      else
                                                                      {
                                                                          <span class="text-muted">N/A</span> @* Gi√° tr·ªã m·∫∑c ƒë·ªãnh *@
                                                                      }
                                                                  }
                                                              </td>
                                                          }
                                                          @* neu ton tai cot co isparent thi xu ly tiep cot 2 cap *@
                                                          @if (displayList.Any(p => p.isparent == true))
                                                          {
                                                              @* hien thi cot cha *@
                                                              @foreach (var display in displayList.Where(p => p.isdisplay == true && p.isparent == true).OrderBy(p => p.colnum ?? 0).ToList())
                                                              {
                                                                  @* dem so cot con de tinh colspan *@
                                                                  var countChild = displayList.Count(p => p.parentcode == display.code);
                                                                  @* neu co cot con thi xu ly tiep *@
                                                                  if (countChild > 0)
                                                                  {
                                                                      @foreach (var displaychild in displayList.Where(p => p.isdisplay == true && p.parentcode == display.code).OrderBy(p => p.colnum ?? 0).ToList())
                                                                      {
                                                                          @* m·∫∑c ƒë·ªãnh type l√† string *@
                                                                          var displayType = displaychild.type as string ?? "string";
                                                                          var displayFormat = displaychild.format as string ?? "";
                                                                          string[] numberTypeArray = ["int", "float", "long"];
                                                                          string[] dateTypeArray = ["date", "datetime"];
                                                                          <td class="@FormatHelper.ParseTextAlignToClass(displaychild.textalign)" data-isexport="@(displaychild.isexport ?? "0") form-control-validation fv-plugins-icon-container" data-displaytype="@displayType" data-displayformat="@displayFormat">
                                                                              @{
                                                                                  object value;
                                                                                  if (dictionary.TryGetValue(displaychild.code, out value))
                                                                                  {
                                                                                      string valueType = "";
                                                                                      // kiem tra kieu du lieu cua value
                                                                                      if (@value != null)
                                                                                      {
                                                                                          valueType = value.GetType().ToString();
                                                                                      }

                                                                                      // uu tien kiem tra kieu du lieu cua value roi den display
                                                                                      // neu kieu du lieu cua value la boolean thi su dung check box
                                                                                      @if (valueType == "System.Boolean" || displayType == "boolean")
                                                                                      {
                                                                                          <input class="form-check-input track-change" type="checkbox" name="@("grid["+@reportRowIndex+"]."+displaychild.code)" value="true" @(Convert.ToBoolean(value ?? false) ? "checked" : "") @(displaychild.validationrule != "[]" ? "required" : "") @(Convert.ToBoolean(displaychild.isreadonly ?? false) ? "disabled" : "") />

                                                                                      }
                                                                                      else if (displayType == "icons")
                                                                                      {
                                                                                          var iconsJson = value?.ToString()?.Trim() ?? "";

                                                                                          // N·∫øu r·ªóng th√¨ b·ªè qua
                                                                                          if (!string.IsNullOrEmpty(iconsJson))
                                                                                          {
                                                                                              // ƒê·∫£m b·∫£o chu·ªói JSON lu√¥n l√† m·∫£ng
                                                                                              if (iconsJson.TrimStart().StartsWith("{"))
                                                                                              {
                                                                                                  iconsJson = "[" + iconsJson + "]";
                                                                                              }

                                                                                              try
                                                                                              {
                                                                                                  var icons = JsonSerializer.Deserialize<List<JsonElement>>(iconsJson);

                                                                                                  <ul class="list-unstyled m-0 avatar-group d-flex align-items-center">
                                                                                                      @foreach (var icon in icons)
                                                                                                      {
                                                                                                          var title = icon.GetProperty("title").GetString();
                                                                                                          var image = icon.GetProperty("image").GetString();
                                                                                                          <li data-bs-toggle="tooltip"
                                                                                                              data-popup="tooltip-custom"
                                                                                                              data-bs-placement="top"
                                                                                                              class="avatar avatar-xs pull-up"
                                                                                                              aria-label="@title"
                                                                                                              data-bs-original-title="@title">
                                                                                                              <img src="@image" alt="Avatar" class="rounded-circle" />
                                                                                                          </li>
                                                                                                      }
                                                                                                  </ul>
                                                                                              }
                                                                                              catch (SqlException ex)
                                                                                              {
                                                                                                  <span class="text-danger">N/A</span>
                                                                                              }
                                                                                          }
                                                                                      }
                                                                                      // neu dang file thi hien thi icon t·∫£i nhi·ªÅu file
                                                                                      else if (displayType == "file")
                                                                                      {
                                                                                          var filesJson = value?.ToString()?.Trim() ?? "";

                                                                                          // N·∫øu r·ªóng th√¨ b·ªè qua
                                                                                          if (!string.IsNullOrEmpty(filesJson))
                                                                                          {
                                                                                              // N·∫øu l√† object ƒë∆°n, bao l·∫°i th√†nh m·∫£ng
                                                                                              if (filesJson.StartsWith("{"))
                                                                                              {
                                                                                                  filesJson = "[" + filesJson + "]";
                                                                                              }

                                                                                              try
                                                                                              {
                                                                                                  var fileList = JsonSerializer.Deserialize<List<JsonElement>>(filesJson);

                                                                                                  if (fileList?.Count > 0)
                                                                                                  {
                                                                                                      <div class="d-flex flex-wrap gap-1">
                                                                                                          @foreach (var file in fileList)
                                                                                                          {
                                                                                                              var fileName = file.GetProperty("fileName").GetString();
                                                                                                              var url = file.GetProperty("url").GetString();
                                                                                                              var displayName = fileName?.Length > 50 ? fileName.Substring(0, 50) + "..." : fileName;

                                                                                                              <a href="@url" download class="btn btn-sm btn-outline-primary file-download-link" title="@fileName">
                                                                                                                  <i class="ri-download-2-fill"></i> @displayName
                                                                                                              </a>
                                                                                                          }
                                                                                                      </div>
                                                                                                  }
                                                                                              }
                                                                                              catch
                                                                                              {
                                                                                                  <span class="text-danger">L·ªói ƒë·ªãnh d·∫°ng file JSON</span>
                                                                                              }
                                                                                          }
                                                                                      }
                                                                                      // neu la kieu link thi parse thanh html
                                                                                      else if (displayType == "link")
                                                                                      {
                                                                                          @Html.Raw(value)
                                                                                          ;
                                                                                      }
                                                                                      // ki·ªÉu string
                                                                                      else if (displayType == "string")
                                                                                      {
                                                                                          <input class="form-control track-change @FormatHelper.ParseTextAlignToClass(displaychild.textalign)" type="text" name="@("grid["+@reportRowIndex+"]."+displaychild.code)" value="@value" @(Convert.ToBoolean(displaychild.isreadonly ?? false) ? "readonly" : "") @(displaychild.validationrule != "[]" ? "required" : "") />
                                                                                      }
                                                                                      // ki·ªÉu color
                                                                                      else if (displayType == "color")
                                                                                      {
                                                                                        <div class="pickr">
                                                                                          <button type="button" id="@("color-"+("grid-"+@reportRowIndex+"-"+displaychild.code))" class="pcr-button form-color-picker" role="button" @(Convert.ToBoolean(displaychild.isreadonly ?? false) ? "disabled" : "")></button>
                                                                                          <input type="hidden" class="track-change" id="@("grid-"+@reportRowIndex+"-"+displaychild.code)" name="@("grid["+@reportRowIndex+"]."+displaychild.code)" value="@value"  @(displaychild.validationrule != "[]" ? "required" : "") />
                                                                                        </div>
                                                                                      }
                                                                                      // ki·ªÉu textarea
                                                                                      else if (displayType == "textarea")
                                                                                      {
                                                                                          <textarea row="2" class="form-control track-change @FormatHelper.ParseTextAlignToClass(displaychild.textalign)" name="@("grid["+@reportRowIndex+"]."+displaychild.code)" aria-label="@displaychild.name" @(Convert.ToBoolean(displaychild.isreadonly ?? false) ? "readonly" : "") @(displaychild.validationrule != "[]" ? "required" : "")>@value</textarea>
                                                                                      }
                                                                                      // neu la kieu number thi hien thi input number
                                                                                      else if (numberTypeArray.Contains(displayType))
                                                                                      {
                                                                                          <input class="form-control track-change @FormatHelper.ParseTextAlignToClass(displaychild.textalign)" type="number" placeholder="" name="@("grid["+@reportRowIndex+"]."+displaychild.code)" aria-label="@displaychild.name" value="@value" @(Convert.ToBoolean(displaychild.isreadonly ?? false) ? "readonly" : "") @(displaychild.validationrule != "[]" ? "required" : "")>
                                                                                      }
                                                                                      // ki·ªÉu ng√†y
                                                                                      else if (dateTypeArray.Contains(displayType))
                                                                                      {
                                                                                          string[] dateFormatArray = ["dd/MM/yyyy", ""];
                                                                                          string dateBoxType = "";
                                                                                          if (displayType == "date" && dateFormatArray.Contains(displayFormat))
                                                                                          {
                                                                                              dateBoxType = "date";
                                                                                          }
                                                                                          else
                                                                                          {
                                                                                              dateBoxType = "datetime-local";
                                                                                          }

                                                                                          <input type="@dateBoxType" class="form-control track-change @FormatHelper.ParseTextAlignToClass(displaychild.textalign)" name="@("grid["+@reportRowIndex+"]."+displaychild.code)" aria-label="@displaychild.name" value="@value" @(Convert.ToBoolean(displaychild.isreadonly ?? false) ? "readonly" : "") @(displaychild.validationrule != "[]" ? "required" : "")>
                                                                                      }
                                                                                      else if (displayType == "combobox")
                                                                                      {
                                                                                          // check selected cho item dung voi gia tri
                                                                                          var selectList = editorDynamicServiceSelectOptions[displaychild.code] as List<SelectListItem> ?? new List<SelectListItem>();
                                                                                          @foreach (var item in selectList)
                                                                                          {
                                                                                              if (value != null)
                                                                                              {
                                                                                                  item.Selected = (item.Value.ToString() == value.ToString()); // currentValue l√† gi√° tr·ªã ƒëang ƒë∆∞·ª£c ch·ªçn
                                                                                              }
                                                                                          }
                                                                                          var selectAttributes = new Dictionary<string, object>
                                                  {
                                                  { "class", "form-select track-change" },
                                                  { "name", ("grid["+@reportRowIndex+"]."+displaychild.code) }
                                                  };

                                                                                          // neu bat buoc thi them truong bat buoc
                                                                                          if (displaychild.validationrule != "[]")
                                                                                          {
                                                                                              selectAttributes["required"] = "required";
                                                                                          }

                                                                                          @Html.DropDownList(("grid[" + @reportRowIndex + "]." + display.code), selectList, "-- Ch·ªçn --", selectAttributes)
                                                                                      }
                                                                                      else if (displayType == "radio")
                                                                                      {
                                                                                          // check selected cho item dung voi gia tri
                                                                                          var selectList = editorDynamicServiceSelectOptions[displaychild.code] as List<SelectListItem> ?? new List<SelectListItem>();

                                                                                          @if (selectList != null)
                                                                                          {
                                                                                              foreach (var item in selectList)
                                                                                              {
                                                                                                  <div class="form-check form-check-inline track-change">
                                                                                                      <input type="radio" class="form-check-input"
                                                                                                              name="@("grid["+@reportRowIndex+"]."+displaychild.code)"
                                                                                                              id="@(("grid["+@reportRowIndex+"]."+displaychild.code) + "_" + item.Value)"
                                                                                                              value="@item.Value"
                                                                                                      @((value ?? "").ToString() == item.Value.ToString() ? "checked" : "") />
                                                                                                      <label class="form-check-label" for="@(("grid["+@reportRowIndex+"]."+displaychild.code) + "_" + item.Value)">@item.Text</label>
                                                                                                  </div>
                                                                                              }
                                                                                          }
                                                                                      }
                                                                                      else
                                                                                      {
                                                                                          <input class="form-control track-change @FormatHelper.ParseTextAlignToClass(displaychild.textalign)" type="text" name="@("grid["+@reportRowIndex+"]."+displaychild.code)" value="@value" @(Convert.ToBoolean(displaychild.isreadonly ?? false) ? "readonly" : "") @(displaychild.validationrule != "[]" ? "required" : "") />
                                                                                      }                                              }
                                                                                  else
                                                                                  {
                                                                                      <span class="text-muted">N/A</span> @* Gi√° tr·ªã m·∫∑c ƒë·ªãnh *@
                                                                                  }
                                                                              }
                                                                              else
                                                                              {
                                                                              <span class="text-muted">N/A</span> @* Gi√° tr·ªã m·∫∑c ƒë·ªãnh *@
                                                                              }
                                                                              }
                                                                          </td>
                                                                      }
                                                                  }

                                                              }
                                                          }
                                                          @* them nut xoa cuoi dong *@
                                                          <td class="text-center">
                                                              <input type="hidden" name="grid[@reportRowIndex].isdeleted" value="false" class="isDeleted track-change">
                                                              <button type="button" class="btn-delete btn btn-sm text-danger" onclick="toggleDelete(this)">
                                                                  <i class="ri-delete-bin-line ri-24px"></i>
                                                              </button>
                                                          </td>
                                                      </tr>

                                                      reportRowIndex++;
                                                  }
                                              }
                                          </tbody>
                                      </table>
                                  </div>
                                <!--/ Pagination Start -->
                                <div class="col-12 report-pagination d-flex justify-content-end mt-3">
                                </div>
                                <!--/ Pagination End -->
                              </div>
                            </form>
                          </div>
                        @* end table *@
                    </div>
                </div>           
            @* end data table new *@
        </div>
        @* Modal (popup form) *@
        @* End Modal  *@
    </div> 
    }
    <!-- Content wrapper -->
</div>
