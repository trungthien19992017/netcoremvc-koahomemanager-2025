@inject IHttpContextAccessor httpContextAccessor

<!DOCTYPE html>
<html lang="en"
  class='light-style layout-menu-fixed'
  data-theme="theme-default" data-assets-path='@((httpContextAccessor.HttpContext?.Request.PathBase ?? "") + "/")'
  data-framework="aspnetcore-mvc"
  data-template='vertical-menu-aspnet-core-mvc-template-free'>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="~/css/replete-modal.css">
    <link rel="stylesheet" href="~/css/select2.css">
    <link rel="stylesheet" href="~/css/animate.css">

    <!-- Th√™m moment.js ƒë·ªÉ x·ª≠ l√Ω ng√†y gi·ªù ch√≠nh x√°c -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

  @{
        string title = ViewData["title"] as string ?? "";
        string appName = TempData.Peek("appName") as string ?? "";
        string productPage = TempData.Peek("productPage") as string ?? "";
    }
  <title>@title | @appName - Asp.Net Core MVC Product</title>
  <meta name="description" content="" />

  <!-- Canonical SEO -->
  <link rel="canonical" href='@productPage'>
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="~/img/icons/koa/koa-mascos-icon.ico" />

  <!-- Core Styles -->
  @await Html.PartialAsync("Sections/_Styles")

  <!-- Vendor Styles -->
  @RenderSection("VendorStyles", required: false)

  <!-- Page Styles -->
  @RenderSection("PageStyles", required: false)


  <!-- Include Scripts for customizer, helper, analytics, config -->
  @await Html.PartialAsync("Sections/_ScriptsIncludes")
</head>

<body>
  @RenderSection("Success", required: false)
  @RenderSection("ErrorMessage", required: false)
  <!-- Layout Content -->
  @RenderBody()
  <!--/ Layout Content -->

  <!-- Core Scripts -->
  @await Html.PartialAsync("Sections/_Scripts")

  <!-- Vendor Scripts -->
  @RenderSection("VendorScripts", required: false)



  <!-- Main JS-->
  <script src='~/js/main.js'></script>
  <script src='~/js/replete-modal.js'></script>


    <!--  script xu ly chung duoc viet trong master-->
  <script>
          // tim kiem trong select box
        $(document).ready(function () {
            function initSelect2() {
                $("select").not(".select2-hidden-accessible").select2({
                    placeholder: "Ch·ªçn",
                    allowClear: true,
                    width: "100%"
                });
            }

            // Kh·ªüi t·∫°o Select2 cho c√°c select ƒë√£ c√≥ s·∫µn
            initSelect2();

            // // √Åp d·ª•ng Select2 cho c√°c select ƒë∆∞·ª£c th√™m ƒë·ªông
            // $(document).on('focus', 'select', function () {
            //     if (!$(this).hasClass("select2-hidden-accessible")) {
            //         $(this).select2({
            //             placeholder: "Ch·ªçn",
            //             allowClear: true,
            //             width: "100%"
            //         });
            //     }
            // });
        });

          // focus vao field dau tien khong hop le
        $("form").on("submit", function (event) {
        var firstInvalid = $(this).find(":invalid").first();
        if (firstInvalid.length) {
        firstInvalid.focus();
        event.preventDefault(); // NgƒÉn kh√¥ng cho form submit
        }
        });

        // data fill sau khi on change select box
        $(document).ready(function () {
        $("select").change(function () {
        let value = $(this).val();
        let key = $(this).attr("name"); // L·∫•y name c·ªßa select
        let datafillstore = $(this).data("datafillstore"); // L·∫•y gi√° tr·ªã t·ª´ data-datafillstore

        if (value && datafillstore) {
        $.ajax({
        url: `/HsBookings/GetDataFillSelection`, // S·ª≠ d·ª•ng serviceStore ƒë·ªÉ x√°c ƒë·ªãnh API c·∫ßn g·ªçi
        type: "GET",
        data: { value: value, key: key, datafillstore : datafillstore },
        success: function (data) {
        console.log("D·ªØ li·ªáu tr·∫£ v·ªÅ:", data);
        console.log("Lo·∫°i d·ªØ li·ªáu:", typeof data); // Ph·∫£i l√† "object"

        $.each(data, function (key, value) {
        let inputField = $(`[name='${key}'], [id='${key}']`);
        if (inputField.length) {
            if (inputField.is(":radio")) {
                // T√¨m radio button c√≥ gi√° tr·ªã t∆∞∆°ng ·ª©ng
                let radioToCheck = inputField.filter(`[value='${value}']`);

                if (radioToCheck.length) {
                    // N·∫øu c√≥ radio button ph√π h·ª£p, ch·ªçn n√≥
                    radioToCheck.prop("checked", true);
                } else {
                    // N·∫øu kh√¥ng t√¨m th·∫•y gi√° tr·ªã t∆∞∆°ng ·ª©ng, b·ªè ch·ªçn t·∫•t c·∫£ radio c·ªßa nh√≥m ƒë√≥
                    inputField.prop("checked", false);
                }
            } else {
                // N·∫øu l√† input b√¨nh th∆∞·ªùng, g√°n gi√° tr·ªã tr·ª±c ti·∫øp
                inputField.val(value);
            }
        }
            });
        },
        error: function (xhr, status, error) {
        console.error("Error:", xhr.responseText);
        }
        });
        }
        });
        });

  
        // // xu ly du lieu datetime truyen vao
        // function formatDateTimeLocal(value) {
        //     return value ? moment(value, "M/D/YYYY h:mm:ss A").format("YYYY-MM-DDTHH:mm") : "";
        // }

        // function formatDate(value) {
        //     // Parse the date using moment.js and format it to 'YYYY-MM-DD'
        //     return value ? moment(value, ["M/D/YYYY h:mm:ss A", "YYYY-MM-DDTHH:mm:ss", "YYYY-MM-DD"]).format("YYYY-MM-DD") : "";
        // }

        // function formatTime(value) {
        //     return value ? moment(value, "h:mm:ss A").format("HH:mm") : "";
        // }

        // var formData = @Html.Raw(Json.Serialize(ViewBag.FormData));
        // if (formData != null)
        // {
        //   $(document).ready(function () {
        //       $.each(formData, function (key, value) {
        //           let inputField = $(`[name='${key}'], [id='${key}']`); // T√¨m input theo name ho·∫∑c id

        //           if (inputField.length) {
        //               let inputType = inputField.attr("type"); // L·∫•y ki·ªÉu input
        //               let isoFormatRegex1 = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/; // regex kiem tra dinh dang date YYYY-MM-DDTHH:mm:ss
        //               let isoFormatRegex2 = /^\d{4}-\d{2}-\d{2}$/; // regex kiem tra dinh dang date YYYY-MM-DD
        //               let isoFormatRegex3 = /^\d{2}:\d{2}:\d{2}$/; // regex kiem tra dinh dang date HH:mm

        //               if (inputType === "datetime-local") {
        //                   if (isoFormatRegex1.test(value) == false)
        //                   {
        //                     value = formatDateTimeLocal(value);
        //                     inputField.val(value); // G√°n gi√° tr·ªã v√†o input
        //                   }
        //                   else
        //                   {
        //                     inputField.val(value); // G√°n gi√° tr·ªã v√†o input
        //                     console.log("PaymentDate value:", value)
        //                   }
        //               } 
        //               else if (inputType === "date" && isoFormatRegex2.test(value) == false) {
        //                   value = formatDate(value);
        //                   inputField.val(value); // G√°n gi√° tr·ªã v√†o input
        //               } 
        //               else if (inputType === "time" && isoFormatRegex3.test(value) == false) {
        //                   value = formatTime(value);
        //                   inputField.val(value); // G√°n gi√° tr·ªã v√†o input
        //               }

        //           }
        //       });
 
        //   });
        // }

        // sau khi load, tu dong cap nhat format date
        $(document).ready(function () {
            // L·∫•y t·∫•t c·∫£ c√°c input c√≥ type="date" ho·∫∑c "datetime-local"
            $('input[type="date"], input[type="datetime-local"]').each(function () {
                let originalValue = $(this).attr('value');

                if (originalValue) {
                    if ($(this).attr("type") === "date") {
                        // Ki·ªÉm tra xem ƒë√£ ƒë√∫ng ƒë·ªãnh d·∫°ng YYYY-MM-DD ch∆∞a
                        let isoDateRegex = /^\d{4}-\d{2}-\d{2}$/;
                        if (!isoDateRegex.test(originalValue)) {
                            let formattedDate = moment(originalValue, ["M/D/YYYY h:mm:ss A", "DD/MM/YYYY", "YYYY-MM-DD"]).format("YYYY-MM-DD");
                            $(this).val(formattedDate); // ƒêi·ªÅn tr·ª±c ti·∫øp v√†o value
                            $(this).attr("value", formattedDate); // C·∫≠p nh·∫≠t l·∫°i gi√° tr·ªã trong HTML
                        }
                    } else if ($(this).attr("type") === "datetime-local") {
                        // Ki·ªÉm tra xem ƒë√£ ƒë√∫ng ƒë·ªãnh d·∫°ng YYYY-MM-DDTHH:mm ch∆∞a
                        let isoDateTimeRegex = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/;
                        if (!isoDateTimeRegex.test(originalValue)) {
                            let formattedDateTime = moment(originalValue, ["M/D/YYYY h:mm:ss A", "DD/MM/YYYY HH:mm:ss", "YYYY-MM-DDTHH:mm:ss"]).format("YYYY-MM-DDTHH:mm");
                            $(this).val(formattedDateTime); // ƒêi·ªÅn tr·ª±c ti·∫øp v√†o value
                            $(this).attr("value", formattedDateTime); // C·∫≠p nh·∫≠t l·∫°i gi√° tr·ªã trong HTML
                        }
                    }
                }
            });
        });

          // function xoa d√≤ng √°p d·ª•ng cho report editor
          function toggleDelete(button) {
            var row = $(button).closest("tr");
            var isDeletedInput = row.find(".isDeleted");
            var idInput = row.find("input[name$='Id']").val();

            if (idInput === "" || idInput === null) {
                row.remove(); // X√≥a d√≤ng n·∫øu Id r·ªóng
            } else {
                var isDeleted = isDeletedInput.val() === "true";
                isDeletedInput.val(!isDeleted);

                if (!isDeleted) {
                    $(button).html('<i class="ri-recycle-line ri-24px text-warning"></i>');
                    // ‚úÖ ƒê√°nh d·∫•u d√≤ng ƒë√£ thay ƒë·ªïi (neu co)
                    row.attr("data-changed", "true");
                } else {
                    $(button).html('<i class="ri-delete-bin-line ri-24px text-danger"></i>');
                }
            }
        }

        // kiem tra de xet readonly form
          $(document).ready(function () {
            var isReadOnly = @Json.Serialize(ViewBag.IsReadOnly);
            if (isReadOnly) {
              // Ch·ªâ ƒë·∫∑t readonly cho input, textarea
              $("form input, form textarea").prop("readonly", true);

              // Ch·ªâ ƒë·∫∑t disable cho select
              $("form select").prop("disabled", true);

              // Ch·ªâ disable n√∫t submit
              $("form button[type='submit']").prop("disabled", true);
            }
        });

        // loai bo disable cho select trong truong hop form submit (ly do khi disabled thi IFormColletion khong lay duoc gia tri)
        $(document).ready(function () {
            $("form").on("submit", function () {
                    $("select:disabled").prop("disabled", false);
                });
        });

        // xu ly spinner khi load
        $(document).ready(function () {
            // Th√™m Spinner v√†o body khi trang t·∫£i
            $("body").append(`
            <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: #96929e;opacity: 0.5;z-index: 2000;display: flex;justify-content: center;align-items: center;pointer-events: none;">
                <div id="spinner" style="background: rgba(0, 0, 0, 0.7);padding: 20px;border-radius: 10px;text-align: center;box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);">
                    <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                      </div>
                    <p style="text-align:center; font-weight:bold; color: white;">ƒêang x·ª≠ l√Ω...</p>
                </div>
            </div>
            `);

          let loadingTimeout;

          // Ch·ªâ hi·ªÉn th·ªã spinner sau 2 gi√¢y khi trang load
          loadingTimeout = setTimeout(() => {
              $("#loading-overlay").show();
          }, 1000);

          // Khi trang load xong, h·ªßy timeout v√† ·∫©n spinner
          $(window).on("load", function () {
              clearTimeout(loadingTimeout);
              $("#loading-overlay").hide();
          });

          // Khi submit form, ch·ªâ hi·ªÉn th·ªã sau 2 gi√¢y
          $(document).on("submit", "form", function () {
              clearTimeout(loadingTimeout);
              loadingTimeout = setTimeout(() => {
                  $("#loading-overlay").show();
              }, 1000);
          });

          // Khi AJAX request g·ª≠i ƒëi, ch·ªâ hi·ªÉn th·ªã sau 2 gi√¢y
          $(document).ajaxStart(function () {
              clearTimeout(loadingTimeout);
              loadingTimeout = setTimeout(() => {
                  $("#loading-overlay").show();
              }, 1000);
          });

          // Khi AJAX request ho√†n t·∫•t, ·∫©n spinner ngay l·∫≠p t·ª©c
          $(document).ajaxComplete(function () {
              clearTimeout(loadingTimeout);
              $("#loading-overlay").hide();
          });

          // ·∫®n spinner n·∫øu c√≥ l·ªói khi t·∫£i trang ho·∫∑c request th·∫•t b·∫°i
          $(window).on("error", function () {
              clearTimeout(loadingTimeout);
              $("#loading-overlay").hide();
          });
        });

        // xu ly confirm action de hien thi popup confirm va xu ly ajax
        $('.confirmAction').on('click', function (e) {
            e.preventDefault(); // NgƒÉn ch·∫∑n ƒëi·ªÅu h∆∞·ªõng khi click v√†o link

            var id = $(this).data('id'); // L·∫•y ID t·ª´ thu·ªôc t√≠nh data-id
            var sqlstore = $(this).data('sqlstore'); // lay du lieu store de xu ly (bat buoc)
            var confirmtext = $(this).data('confirmtext');

            rplm({
                title: "X√°c nh·∫≠n",
                text: confirmtext || "H√£y gi√∫p t√¥i x√°c nh·∫≠n l·∫°i l·∫ßn n·ªØa nh√©",
                type: "warning",
                showCancelButton: true,
                confirmButtonText: "ƒê·ªìng √Ω!",
                cancelButtonText: "H·ªßy!",
                animation: "tada",
                modalNOverlay: "backShadow",
                closeOnConfirm: false,
                closeOnCancel: false,
                showLoaderOnConfirm: true
            },
            function (isConfirm) {
                if (isConfirm) {
                    // dua cac du lieu can truyen vao formdata
                    var formData = new FormData();
                    formData.append("Id", id); // key cua du lieu
                    formData.append("sqlstore", sqlstore); // L·∫•y sqlstore tu button truyen vao

                    // G·ªçi AJAX ƒë·ªÉ g·ª≠i y√™u c·∫ßu x√≥a
                    $.ajax({
                        url: '/Home/Action_Confirmed', // Controller x·ª≠ l√Ω x√≥a
                        type: 'POST', // Ho·∫∑c 'GET' n·∫øu ph√π h·ª£p
                        data: formData, // Truy·ªÅn ID c·ªßa d√≤ng c·∫ßn x√≥a v√† store x·ª≠ l√Ω
                        processData: false, // Kh√¥ng chuy·ªÉn `FormData` th√†nh query string
                        contentType: false, // ƒê·ªÉ tr√¨nh duy·ªát t·ª± ƒë·ªông ƒë·∫∑t `content-type`
                        success: function (response) {
                            if (response.success) {
                                rplm({
                                  title: "X·ª≠ l√Ω th√†nh c√¥ng!",
                                  text: "H√†nh ƒë·ªông c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω.",
                                  type: "success",
                                  timer: 2000,
                                  confirmButtonText: 'X√°c nh·∫≠n',
                                }, function () {
                                      // Sau khi ƒë√≥ng popup, reload l·∫°i trang
                                      location.reload();
                                  });
                            } else {
                                rplm({
                                    title: "L·ªói!",
                                    text: response.errorMessage || "C√≥ v·∫•n ƒë·ªÅ x·∫£y ra.",
                                    type: "error",
                                    timer: 2000,
                                    confirmButtonText: 'X√°c nh·∫≠n',
                                });
                            }
                        },
                        error: function () {
                            rplm({
                                title: "L·ªói!",
                                text: "L·ªói khi k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.",
                                type: "error",
                                timer: 2000,
                                confirmButtonText: 'Done',
                            });
                        }
                    });
                } else {
                    rplm({
                        title: "ƒê√£ h·ªßy!",
                        text: "H√†nh ƒë·ªông c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c h·ªßy.",
                        type: "error",
                        timer: 2000,
                        confirmButtonText: 'Done',
                    });
                }
            });
        });
          // xu ly form popup
          $(document).ready(function () {
            // Khi modal ƒë∆∞·ª£c m·ªü
              $(".popup-form-action").click(function () {
                var id = $(this).data("id"); // L·∫•y ID c·ªßa booking
                var sqlStore = $(this).data('sqlstore'); // L·∫•y SQL Store n·∫øu c·∫ßn
                // neu khong truyen action va controller thi se goi action mac dinh
                var controller = $(this).data("controller") || "HsBookings";
                var action = $(this).data("action") || "GetDataFillSelection";

                // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ ID th√¨ kh√¥ng l√†m g√¨
                if (!id) return;

                // G·ªçi AJAX l·∫•y d·ªØ li·ªáu t·ª´ action
                $.ajax({
                url: `/${controller}/${action}`, // S·ª≠ d·ª•ng serviceStore ƒë·ªÉ x√°c ƒë·ªãnh API c·∫ßn g·ªçi
                type: "GET",
                data: { value: id, key: "Id", datafillstore : sqlStore },
                success: function (data) {
                console.log("D·ªØ li·ªáu tr·∫£ v·ªÅ:", data);
                console.log("Lo·∫°i d·ªØ li·ªáu:", typeof data); // Ph·∫£i l√† "object"

                $.each(data, function (key, value) {
                let inputField = $(`[name='${key}'], [id='${key}']`);
                if (inputField.length) {
                    if (inputField.is(":radio")) {
                        // T√¨m radio button c√≥ gi√° tr·ªã t∆∞∆°ng ·ª©ng
                        let radioToCheck = inputField.filter(`[value='${value}']`);

                        if (radioToCheck.length) {
                            // N·∫øu c√≥ radio button ph√π h·ª£p, ch·ªçn n√≥
                            radioToCheck.prop("checked", true);
                        } else {
                            // N·∫øu kh√¥ng t√¨m th·∫•y gi√° tr·ªã t∆∞∆°ng ·ª©ng, b·ªè ch·ªçn t·∫•t c·∫£ radio c·ªßa nh√≥m ƒë√≥
                            inputField.prop("checked", false);
                        }
                    }
                    else if (inputField.is("select"))
                    {
                      // gan gia tri selected
                      let selectedvalue = value
                      if (inputField.hasClass("select2-hidden-accessible"))
                      {
                       inputField.select2("destroy");
                      }
                      inputField.empty().append('<option value="">Ch·ªçn</option>');  // X√≥a c√°c option c≈© // Th√™m option m·∫∑c ƒë·ªãnh

                      // Th√™m c√°c option m·ªõi
                      let selectlistkey = "List"+key
                      console.log("Dropdown field:", inputField);
                      console.log("Data list:", data[selectlistkey]);
                      if (data[selectlistkey] && Array.isArray(data[selectlistkey])) { // Ki·ªÉm tra danh s√°ch h·ª£p l·ªá
                          let options = data[selectlistkey].map(item => {
                              return new Option(item.name, item.id, false, item.id == selectedvalue);
                          });

                          inputField.append(options);
                      } else {
                          console.error("Danh s√°ch kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu.");
                      }
 
                      if (inputField.not(".select2-hidden-accessible"))
                      {
                          $(document).ready(function() {
                              inputField.select2({
                                  placeholder: "Ch·ªçn",
                                  allowClear: true,
                                  width: "100%",
                                  dropdownParent: $('#modal-GiamGiaPhatSinh') // Ch·ªâ ƒë·ªãnh modal l√†m container
                              });
                          });
                      }
                    }
                    else {
                        // N·∫øu l√† input b√¨nh th∆∞·ªùng, g√°n gi√° tr·ªã tr·ª±c ti·∫øp
                        inputField.val(value);
                    }
                }
                    });
                },
                error: function (xhr, status, error) {
                console.error("Error:", xhr.responseText);
                }
                });
            });

            // khong chu dong submit form ma thong qua button de tranh viec form tu xu ly
            $(".modal-btn-submit").click(function () {
                // $(this).closest("form").submit();
                var form = $(this).closest("form").get(0); // L·∫•y HTMLFormElement

                // kiem tra neu co validate thi bao loi va return
                if (!form.checkValidity()) {
                    form.classList.add("was-validated"); // K√≠ch ho·∫°t CSS validation c·ªßa Bootstrap
                    return;
                }

                $(this).closest("form").submit(); // N·∫øu h·ª£p l·ªá, submit form
            });

           // xu ly luu form popup
            $(".modal-form").submit(function (e) {
                e.preventDefault(); // NgƒÉn form reload trang

                let form = $(this);
                let modalId = $(this).data("modal-id");
                var formData = new FormData(this); // T·∫°o FormData t·ª´ form

                $.ajax({
                    type: form.attr("method"),
                    url: form.attr("action"),
                    data: formData,
                    processData: false, // Kh√¥ng chuy·ªÉn `FormData` th√†nh query string
                    contentType: false, // ƒê·ªÉ tr√¨nh duy·ªát t·ª± ƒë·ªông ƒë·∫∑t `content-type`
                    success: function (data) {
                      if (data.success) {
                          rplm({
                            title: "X·ª≠ l√Ω th√†nh c√¥ng!",
                            text: "H√†nh ƒë·ªông c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω.",
                            type: "success",
                            timer: 2000,
                            confirmButtonText: 'X√°c nh·∫≠n',
                          }, function (){
                                $("#"+modalId+" .modal-btn-close").trigger("click");// ƒê√≥ng modal
                                // Sau khi ƒë√≥ng popup, reload l·∫°i trang
                                location.reload();
                            });
                      } else {
                          rplm({
                              title: "L·ªói!",
                              text: data.errorMessage || "C√≥ v·∫•n ƒë·ªÅ x·∫£y ra.",
                              type: "error",
                              timer: 2000,
                              confirmButtonText: 'X√°c nh·∫≠n',
                          });
                      }
                    },
                    error: function (xhr, status, error) {
                        console.log("L·ªói AJAX:", xhr.responseText); // Log l·ªói AJAX
                        rplm({
                            title: "L·ªói!",
                            text: xhr.responseText || "C√≥ v·∫•n ƒë·ªÅ x·∫£y ra.",
                            type: "error",
                            timer: 2000,
                            confirmButtonText: 'X√°c nh·∫≠n',
                        });
                    }
                });
            });
        });

        // kiem tra n·∫øu c√≥ nh·∫≠p li·ªáu tr√™n b·∫•t k√¨ d√≤ng n√†o th√¨ m·ªõi enable n√∫t L∆∞u, v√† d√≤ng n√†o nh·∫≠p li·ªáu th√¨ m·ªõi truy·ªÅn xu·ªëng IFormCollection
        document.addEventListener("DOMContentLoaded", function () {
            // Theo d√µi t·∫•t c·∫£ form tr√™n trang
            document.querySelectorAll("form").forEach(form => {
                const table = form.querySelector("table"); // T√¨m b·∫£ng trong form
                const submitButton = form.querySelector("button[type='submit']");

                if (!table || !submitButton) return; // B·ªè qua n·∫øu kh√¥ng c√≥ b·∫£ng ho·∫∑c n√∫t submit

                function checkChanges() {
                    let hasChanges = false;

                    // neu khong co tr n√†o co attr data change thi mac dinh hien thi nut Luu
                    if (table.querySelectorAll("tr[data-changed]").length == 0)
                    {
                      submitButton.disabled = false;
                      return;
                    }

                    table.querySelectorAll("tr").forEach(row => {
                        if (row.getAttribute("data-changed") === "true") {
                            hasChanges = true;
                        }
                    });

                    submitButton.disabled = !hasChanges; // B·∫≠t/t·∫Øt n√∫t submit
                }

                // Theo d√µi thay ƒë·ªïi trong b·∫£ng (ch·ªâ trong ph·∫°m vi form ch·ª©a n√≥)
                table.addEventListener("input", function (event) {
                    let target = event.target;
                    if (target.classList.contains("track-change")) {
                        let row = target.closest("tr");
                        row.setAttribute("data-changed", "true"); // ƒê√°nh d·∫•u d√≤ng ƒë√£ thay ƒë·ªïi
                        checkChanges();
                    }
                });

                // Ch·ªâ g·ª≠ i d·ªØ li·ªáu c·ªßa b·∫£ng ƒë√£ thay ƒë·ªïi
                form.addEventListener("submit", function (event) {
                    let rows = table.querySelectorAll("tbody tr");

                    rows.forEach(row => {
                        console.log(row.getAttribute('data-changed'));
                      // neu khong khai bao data change thi bo qua, neu co khai bao data change thi kiem tra = false thi xoa 
                        if (row.getAttribute('data-changed') !== undefined && row.getAttribute('data-changed') !== null)
                        {
                          if (row.getAttribute("data-changed") !== "true") {
                            row.remove(); // X√≥a c√°c d√≤ng ch∆∞a thay ƒë·ªïi kh·ªèi form tr∆∞·ªõc khi submit
                          }
                        }
                    });
                });

                checkChanges(); // Ki·ªÉm tra tr·∫°ng th√°i ban ƒë·∫ßu
            });
        });

           // xu ly thong bao
        $(document).ready(function () {
            $.ajax({
                url: `/Notifications/GetNotifications`, // S·ª≠ d·ª•ng serviceStore ƒë·ªÉ x√°c ƒë·ªãnh API c·∫ßn g·ªçi
                type: "GET",
                success: function (data) {
                    let notificationList = $("#notificationList");
                    let badge = $("#notificationBadge");
                    notificationList.empty();
                    let unreadCount = 0;

                    data.forEach(notification => {
                        let item = `
                            <li class="list-group-item list-group-item-action dropdown-notifications-item waves-effect ${notification.IsRead ? 'marked-as-read' : ''}">
                                   <div class="d-flex">
                                       <div class="flex-shrink-0 me-3">
                                           <div class="avatar">
                                               ${notification.Images ? `<img src="${notification.Images}" class="w-px-40 h-auto rounded-circle">` : '<span class="avatar-initial rounded-circle bg-label-danger">N/A</span>'}
                                           </div>
                                       </div>
                                       <div class="flex-grow-1">
                                           <h6 class="small mb-1">${notification.Title}</h6>
                                           <small class="mb-1 d-block text-body">${notification.Content}</small>
                                           <small class="text-muted">${notification.ThoiGian}</small>
                                       </div>
                                    <div class="flex-shrink-0 dropdown-notifications-actions">
                                        <a href="javascript:void(0)" class="dropdown-notifications-read" onclick="markAsRead(${notification.Id})"><span class="badge badge-dot"></span></a>
                                        <a href="javascript:void(0)" class="dropdown-notifications-archive"><span class="ri-close-line"></span></a>
                                    </div>
                                   </div>
                               </li>`;

                        notificationList.append(item);
                        if (!notification.IsRead) unreadCount++;

                        //cap nhat lai event remove notifications
                        document.querySelectorAll(".dropdown-notifications-archive").forEach(t => {
                                  t.addEventListener("click", e => {
                                  t.closest(".dropdown-notifications-item").remove()
                              })
                          })
                    });


                    $('#notificationBadge').html(data.length + " tin nh·∫Øn");
                    if (unreadCount > 0) {
                        badge.show();
                    } else {
                        badge.hide();
                    }
                },
                error: function () {
                    console.error("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu th√¥ng b√°o.");
                }
            });
        });

        function markAsRead(id) {
            $.ajax({
                url: "/Notifications/MarkAsRead",
                method: "POST",
                data: { id: id },
                success: function (data) {
                    location.reload();
                },
                error: function (response) {
                    console.error("Kh√¥ng th·ªÉ ƒë√°nh d·∫•u th√¥ng b√°o ƒë√£ ƒë·ªçc.");
                }
            });
        }

        // xu ly n√∫t xuat export, phan trang doi voi table cau hinh class table-with-exportexcel
         function initExcelExportForTable(selector, options = {}) {
            // gia tri mac dinh
             const defaultOptions = {
                 header: true,
                 footer: true,
                 title: "Export",
                 filename: "export",
                 extension: ".xlsx",
                 createEmptyCells: false,
                 autoFilter: false,
                 sheetName: "Sheet1"
             };

             const config = { ...defaultOptions, ...options };

             $(selector).each(function () {
                 const table = $(this);

                 // xu ly data table
                 table.DataTable({
                     dom: '<"d-flex justify-content-between align-items-center datatable-top-component"<"d-flex gap-2"fl><"d-flex gap-2"B>>irtp',
                     buttons: [
                         {
                             extend: "excelHtml5",
                             className: "buttons-excel buttons-html5 btn btn-primary",
                             text: '<i class="ri-upload-2-line"></i>',
                             filename: config.filename,
                             customize: config.customize || null,
                             exportOptions: config.exportOptions || {},
                             header: config.header,
                             footer: config.footer,
                             title: config.title,
                             messageTop: config.messageTop || null,
                             messageBottom: config.messageBottom || null,
                             autoFilter: config.autoFilter,
                             sheetName: config.sheetName,
                             exportOptions: {
                                 columns: ':visible',
                                 stripHtml: true // Lo·∫°i b·ªè t·∫•t c·∫£ HTML, ch·ªâ l·∫•y vƒÉn b·∫£n
                             },
                             customize: function (xlsx) {
                                 var sheet = xlsx.xl.worksheets["sheet1.xml"];
                                 var rows = $("row", sheet);
                                 // M·∫∑c ƒë·ªãnh t√¥ m√†u header
                                 // rows.eq(0).attr("s", "2");
                                 // $('row:first c', sheet).attr( 's', '42' );
                                 rows.eq(1).find("c").attr("s", "42");
                             }
                         }
                     ],
                     // phan trang
                     lengthMenu: [10, 20, 50, 100], // C√°c t√πy ch·ªçn s·ªë l∆∞·ª£ng b·∫£n ghi
                     pageLength: 20, // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã 25 b·∫£n ghi tr√™n m·ªói trang
                     lengthChange: true,
                     // hien thi
                     language: {
                             lengthMenu: "_MENU_",
                             search: "",
                             searchPlaceholder: "T√¨m ki·∫øm",
                             info: "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ c·ªßa _TOTAL_ k·∫øt qu·∫£"
                         }
                 });

               // Di chuy·ªÉn ph·∫ßn ph√¢n trang ra ngo√†i b·∫£ng
               // doi phan trang va cac nut xuat, t√¨m kiem ra ngoai (yeu cau class table-pagination va table-top-action)
               table.on('draw', function () {
                   $('.dataTables_paginate').appendTo('.table-pagination');
                   $('.datatable-top-component').appendTo('.table-top-action');
               });

               // G·ªçi l·∫ßn ƒë·∫ßu sau khi DataTable load xong
               $('.dataTables_paginate').appendTo('.table-pagination');
               $('.datatable-top-component').appendTo('.table-top-action');
             });
         }

         function getFormattedDateTime() {
             var now = new Date();
             var year = now.getFullYear();
             var month = String(now.getMonth() + 1).padStart(2, '0');
             var day = String(now.getDate()).padStart(2, '0');
             var hours = String(now.getHours()).padStart(2, '0');
             var minutes = String(now.getMinutes()).padStart(2, '0');
             var seconds = String(now.getSeconds()).padStart(2, '0');

             return `${year}${month}${day}_${hours}${minutes}${seconds}`;
         }

         // xu ly n√∫t xuat export, phan trang doi voi table cau hinh class table-with-exportexcel
         $(document).ready(function () {
             // L·∫•y n·ªôi dung title t·ª´ th·∫ª H1
             var pageTitle = $("#header-title").text().trim();

             // Xo√° c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát kh√¥ng h·ª£p l·ªá trong t√™n file (v√≠ d·ª•: !, üéâ, ...)
             var sanitizedFilename = pageTitle.replace(/[^a-zA-Z0-9\u00C0-\u1EF9\s]/g, '').replace(/\s+/g, '_');

             // tim table co class table-with-exportexcel va xu ly
             initExcelExportForTable('.table-with-exportexcel', {
                 // Th√™m timestamp v√†o filename
                 filename: `${sanitizedFilename}_${getFormattedDateTime()}` ?? "Danh s√°ch",
                 title: pageTitle ?? "Danh s√°ch",
                 autoFilter: false,
                 sheetName: "Danh s√°ch"
             });

         });

        // xu ly import file excel de cap nhat va them moi du lieu
         $(document).ready(function () {
           // Khi b·∫•m n√∫t ‚Üí k√≠ch ho·∫°t ch·ªçn file
           document.getElementById("importFileBtn").addEventListener("click", function () {
               document.getElementById("importFileInput").click();
           });

           // Khi ng∆∞·ªùi d√πng ch·ªçn file ‚Üí g·ª≠i file l√™n API
           document.getElementById("importFileInput").addEventListener("change", async function () {
               const file = this.files[0];
               if (!file) return;

               var sqlstore = $(this).data('sqlstore'); // lay du lieu store tu input import de xu ly (bat buoc)

               const formData = new FormData();
               formData.append("file", file);
               formData.append("sqlstore", sqlstore);

               // const resultDiv = document.getElementById("result");
               // resultDiv.innerHTML = "ƒêang x·ª≠ l√Ω...";
               rplm({
                   title: "X√°c nh·∫≠n",
                   text: "Nh·∫≠p file s·∫Ω m·∫•t m·ªôt ch√∫t th·ªùi gian nh√©",
                   type: "warning",
                   showCancelButton: true,
                   confirmButtonText: "ƒê·ªìng √Ω!",
                   cancelButtonText: "H·ªßy!",
                   animation: "tada",
                   modalNOverlay: "backShadow",
                   closeOnConfirm: false,
                   closeOnCancel: false,
                   showLoaderOnConfirm: true
               },
               function (isConfirm) {
                   if (isConfirm) {
                       // G·ªçi AJAX ƒë·ªÉ g·ª≠i y√™u c·∫ßu x√≥a
                       $.ajax({
                           url: '/Home/ImportExcel', // Controller x·ª≠ l√Ω x√≥a
                           type: 'POST', // Ho·∫∑c 'GET' n·∫øu ph√π h·ª£p
                           data: formData, // Truy·ªÅn ID c·ªßa d√≤ng c·∫ßn x√≥a v√† store x·ª≠ l√Ω
                           processData: false, // Kh√¥ng chuy·ªÉn `FormData` th√†nh query string
                           contentType: false, // ƒê·ªÉ tr√¨nh duy·ªát t·ª± ƒë·ªông ƒë·∫∑t `content-type`
                           success: function (response) {
                               if (response.success) {
                                   rplm({
                                     title: "X·ª≠ l√Ω th√†nh c√¥ng!",
                                     text: "H√†nh ƒë·ªông c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω.",
                                     type: "success",
                                     timer: 2000,
                                     confirmButtonText: 'X√°c nh·∫≠n',
                                   }, function () {
                                         // Sau khi ƒë√≥ng popup, reload l·∫°i trang
                                         location.reload();
                                     });
                               } else {
                                   rplm({
                                       title: "L·ªói!",
                                       text: response.errorMessage || "C√≥ v·∫•n ƒë·ªÅ x·∫£y ra.",
                                       type: "error",
                                       timer: 2000,
                                       confirmButtonText: 'X√°c nh·∫≠n',
                                   });
                               }
                           },
                           error: function () {
                               rplm({
                                   title: "L·ªói!",
                                   text: "L·ªói khi k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.",
                                   type: "error",
                                   timer: 2000,
                                   confirmButtonText: 'Done',
                               });
                           }
                       });
                   } else {
                       rplm({
                           title: "ƒê√£ h·ªßy!",
                           text: "H√†nh ƒë·ªông c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c h·ªßy.",
                           type: "error",
                           timer: 2000,
                           confirmButtonText: 'Done',
                       });
                   }
               });
           });
         });
    </script>

    <!-- Page Scripts-->
    @RenderSection("PageScripts", required: false)

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>

</body>

</html>
